<!DOCTYPE html>
<html lang="en">
<head>
 <title>Important Zites</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <meta name="keywords" content="zite,zites,important,krixano,list,category,search,filter">
 <base href="" target="_top" id="base">
 <script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>

 <link rel="stylesheet" href="css/bulma.css" />
 <link rel="stylesheet" href="css/main.css" />

 <script src="js/navToggle.js"></script>

 <style>
 	#messages li {
 		margin-bottom: 5px;
 	}
 	#messages li > b {
 		margin-right: 2px;
 	}
 	#current_user_messages li {
 		margin-bottom: 5px;
 	}
 	#current_user_messages li > b {
 		margin-right: 2px;
 	}
 </style>
</head>
<body>
	<nav class="nav has-shadow">
		<div class="container">
		  <div class="nav-left">
		    <a href="./" class="nav-item" style="font-weight: bold;">Important Zites</a>
		    <span class="nav-item"><code id="zite_num" class="tag is-light" style="display: none;">0</code></span>
		  </div>

		  <!-- This "nav-toggle" hamburger menu is only visible on mobile -->
		  <!-- You need JavaScript to toggle the "is-active" class on "nav-menu" -->
		  <span id="nav-toggle" class="nav-toggle">
		    <span></span>
		    <span></span>
		    <span></span>
		  </span>

		  <!-- This "nav-menu" is hidden on mobile -->
		  <!-- Add the modifier "is-active" to display it on mobile -->
		  <div id="nav-menu" class="nav-right nav-menu">
		    <a href="./" class="nav-item">Home</a>
		    <!--<a class="nav-item">Blog</a>-->
		    <a class="nav-item is-active">Requests</a>
		    <a href="about.html" class="nav-item">About</a>
		    <span class="nav-item"><a href="#Select+user" id="select_user" class="button is-info" onclick='return page.selectUser()'>Select user</a></span>
		  </div>
		</div>
	</nav>

	<section class="section">
		<div class="columns">
			<div class="column is-8 is-offset-2">
				<p>To request a zite be added or removed (in the case a zite is abandoned, etc.), submit the link in the form below. Or you can send me a request by emailing me the link to the zite on ZeroMail via <a href="/Mail.ZeroNetwork.bit/?to=krixano">this link</a>.
				<br><em>Once a zite has been added/removed, the request will be removed.</em></p>
				<h2 class="title is-4" style="margin-top: 20px;">Requests</h2>
				<div class="columns">
					<div class="column is-6">
						<form onsubmit="return page.sendMessage()">
							<div class="field">
				  				<p class="control">
									<input type="url" id="message" name="message" class="input" onkeypress="if (event.keyCode == 13) page.sendMessage()" placeholder="Zite Link" required>
								</p>
							</div>
							<div class="field">
				  				<p class="control">
									<input type="text" id="removal_reason" name="removal_reason" class="input" onkeypress="if (event.keyCode == 13) page.sendMessage()" placeholder="Reason For Removal" style="display: none;">
								</p>
							</div>
							<div class="field">
								<p class="control">
									<label class="radio">
									  <input type="radio" name="request_type" value="a" checked onclick="page.hideRemovalReasonTextbox()">
									  Add
									</label>
									<label class="radio">
									  <input type="radio" name="request_type" value="r" onclick="page.showRemovalReasonTextbox()">
									  Remove
									</label>
								</p>
							</div>
							<div class="field">
								<button class="button is-success">Submit!</button>
							</div>
						</form>
					</div>
				</div>
				<h3 class="title is-6" style="margin-bottom: 5px; font-style: bold;">Your Requests</h3>
				<ul id="current_user_messages">
				</ul>
				<h3 class="title is-6" style="margin-bottom: 5px; margin-top: 15px;">Others' Requests</h3>
				<ul id="messages">
				</ul>
			</div>
		</div>
	</section>

	<footer class="footer">
		<div class="container">
			<span style="text-align: center">
				<small>NOTE: This zite is still a work-in-progress.</small><br>
				<small>Zite created on April 12th, 2017 by <a href="/Me.ZeroNetwork.bit/?Profile/12h51ug6CcntU2aiBjhP8Ns2e5VypbWWtv/12gAes6NzDS9E2q6Q1UXrpUdbPS6nvuBPu/krixano@zeroid.bit">krixano@zeroid.bit</a> (Christian Seibold)</small><br>
				<small><a href="https://github.com/krixano/ImportantZites">Github Link</a></small>
			</span>
		</div>
	</footer>

	<script type="text/javascript" src="js/ZeroFrame.js"></script>
	<!--<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>-->
	<script type="text/javascript" src="js/velocity.min.js"></script>

	<script>
		class ZeroChat extends ZeroFrame {
		    addMessage (username, message, request_type, removal_reason, isByCurrentUser) {
		        var message_escaped = message.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&/g, "&amp;");  // Escape html tags in the message
		        var message_url = message.replace(/http:\/\/127\.0\.0\.1:43110/, "").replace(/127\.0\.0\.1:43110/, "").replace(/http:\/\/localhost:43110/, "").replace(/localhost:43110/, "");
		        
		        var request_type_text = "";
		        if (request_type) {
		        	if (request_type == 'a') {
		        		request_type_text = "Add";
		        	} else if (request_type == 'r') {
		        		request_type_text = "Remove";
		        	}
		        } else {
		        	request_type_text = "Add";
		        }

		        var removal_reason_text = "";
		        if (removal_reason) {
		        	removal_reason_text = "(" + removal_reason + ")";
		        }

		        if (isByCurrentUser == true) {
		        	this.currentUserMessages.innerHTML += "<li><b>" + username + ":</b> <em>" + request_type_text + " <a href='" + message_url + "'>" + message_escaped + "</a> " + removal_reason_text + "</em></li>"
		        } else {
		        	this.messages_container.innerHTML += "<li><b>" + username + ":</b> <em>" + request_type_text +" <a href='" + message_url + "'>" + message_escaped + "</a> " + removal_reason_text + "</em></li>"
		        }
		        //var html = "<li><b>" + username + ":</b> <em><a href='" + message + "'>" + message_escaped + "</a></em></li>";
		        //$(html).hide().appendTo("#messages").fadeIn();
		    }

		    onOpenWebsocket () {
		        this.messages_container = document.getElementById("messages");
		        this.currentUserMessages = document.getElementById("current_user_messages");
		        //this.addMessage("System", "Ready to call ZeroFrame API!");
		        this.cmd("siteInfo", {}, (site_info) => {
		            if (site_info.cert_user_id) {
		                document.getElementById("select_user").innerText = site_info.cert_user_id;
		            }
		            this.site_info = site_info;
		        	this.loadMessages();
		        	this.loadZiteIndicator();
		        });
		    }

		    selectUser () {
	            this.cmd("certSelect", {accepted_domains: ["zeroid.bit", "kaffie.bit"]})
	            return false
	        }

	        onRequest (cmd, message) {
		        if (cmd == "setSiteInfo") {
		            this.site_info = message.params  // Save site info data to allow access it later
		            if (message.params.cert_user_id) {
		                document.getElementById("select_user").innerHTML = message.params.cert_user_id
		                this.loadMessages();
		            } else if (!message.params.cert_user_id) {
		                document.getElementById("select_user").innerHTML = "Select user"
		                this.loadMessages();
		            } else if (message.params.event && message.params.event[0] == "file_done") {
		            	this.loadMessages();
		            	this.loadZiteIndicator();
		            }
		        }
		    }

		    sendMessage() {
		    	// No account selected -> Display error
		    	if (!this.site_info.cert_user_id) {
		    		this.cmd("wrapperNotification", ["info", "Please, select your account."]);
		    		this.selectUser();
		    		return false;
		    	}

		    	// This is the data file path
		    	var data_inner_path = "data/users/" + this.site_info.auth_address + "/data.json";
		    	var content_inner_path = "data/users/" + this.site_info.auth_address + "/content.json";

		    	// Load our current messages
		    	this.cmd("fileGet", {"inner_path": data_inner_path, "required": false}, (data) => {
		    		if (data)
		    			data = JSON.parse(data);
		    		else
		    			data = { "message": [] }

		    		// Get info for data
		    		var request_type = 'a';
		    		var querySelector = document.querySelector('input[name="request_type"]:checked');
		    		if (querySelector) {
		    			request_type = querySelector.value;
		    		}

		    		// Add the new message to data
		    		data.message.push({
		    			"body": document.getElementById("message").value,
		    			"request_type": request_type,
		    			"removal_reason": request_type == 'r' ? document.getElementById("removal_reason").value : "",
		    			"date_added": Date.now()
		    		});

		    		// Encode data array to utf8 json text
		    		var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')));

		    		// Write file to disk
		    		this.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
		    			if (res == "ok") {
		    				// Reset the message input
		    				document.getElementById("message").value = "";
		    				document.getElementById("removal_reason").value = "";
		    				// Sign the changed file in our user's directory
		    				this.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
		    					this.loadMessages(); // Reload Messages
		    					// publish to other users
		    					this.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false});
		    				});
		    			} else {
		    				this.cmd("wrapperNotification", ["error", "File write error: #{res}"]);
		    			}
		    		});
		    	});

		    	return false;
		    }

		    loadMessages() {
	    		this.messages_container.style.display = "none";
	    		this.currentUserMessages.style.display = "none";

		    	this.cmd("dbQuery", ["SELECT * FROM message LEFT JOIN json USING (json_id) ORDER BY date_added DESC"], (messages) => {
		    		this.messages_container.innerHTML = ""; // Always star with empty messages
		    		this.currentUserMessages.innerHTML = "";

		    		for (var i = 0; i < messages.length; i++) {
		    			if (messages[i].cert_user_id == this.site_info.cert_user_id) {
		    				this.addMessage(messages[i].cert_user_id, messages[i].body, messages[i].request_type, messages[i].removal_reason, true);
		    			} else {
	    					this.addMessage(messages[i].cert_user_id, messages[i].body, messages[i].request_type, messages[i].removal_reason, false);
		    			}
		    		}
		    		if (!this.site_info.cert_user_id) {
		        		this.currentUserMessages.innerHTML = "<li id='default'><em>Please <a href='#Select+user' onclick='return page.selectUser()'>Select User</a> to see your requests.</em></li>";
		        	}

		    		Velocity(this.messages_container, "fadeIn", { duration: 500 });
		    		Velocity(this.currentUserMessages, "fadeIn", { duration: 500 });
		    	});
		    }

		    loadZiteIndicator() {
		    	var zite_indicator = document.getElementById('zite_num');
		    	zite_indicator.style.display = "none";

		    	this.cmd("dbQuery", ["SELECT address FROM zites"], (zites) => {
		    		zite_indicator.innerHTML = zites.length + " zites";
		    		Velocity(zite_indicator, "fadeIn", { duration: 500 });
		    	});

		    }

		    hideRemovalReasonTextbox() {
		    	document.getElementById('removal_reason').style.display = "none";
		 	}
		 	showRemovalReasonTextbox() {
		 		document.getElementById('removal_reason').style.display = "";
 			}
		}

		page = new ZeroChat()
	</script>

	<!--<script>

	class Page extends ZeroFrame {
		setSiteInfo(site_info) {
			var out = document.getElementById("out")
			out.innerHTML =
				"Page address: " + site_info.address +
				"<br>- Peers: " + site_info.peers +
				"<br>- Size: " + site_info.settings.size +
				"<br>- Modified: " + (new Date(site_info.content.modified*1000))
		}

		onOpenWebsocket() {
			this.cmd("siteInfo", [], function(site_info) {
				page.setSiteInfo(site_info)
			})
		}

		onRequest(cmd, message) {
			if (cmd == "setSiteInfo")
				this.setSiteInfo(message.params)
			else
				this.log("Unknown incoming message:", cmd)
		}
	}
	page = new Page()

	</script>-->

</body>
</html>