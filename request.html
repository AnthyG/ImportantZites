<!DOCTYPE html>
<html lang="en">
<head>
 <title>Important Zites</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <meta name="keywords" content="zite,zites,important,krixano,list,category,search,filter">
 <base href="" target="_top" id="base">
 <script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>

 <link rel="stylesheet" href="css/bulma.css" />
 <link rel="stylesheet" href="css/main.css" />

 <script src="js/navToggle.js"></script>

 <style>
 	#messages li {
 		margin-bottom: 5px;
 	}
 	#messages li > b {
 		margin-right: 2px;
 	}
 </style>
</head>
<body>
	<nav class="nav has-shadow">
		<div class="container">
		  <div class="nav-left">
		    <a href="index.html" class="nav-item" style="font-weight: bold;">Important Zites</a>
		  </div>

		  <!-- This "nav-toggle" hamburger menu is only visible on mobile -->
		  <!-- You need JavaScript to toggle the "is-active" class on "nav-menu" -->
		  <span id="nav-toggle" class="nav-toggle">
		    <span></span>
		    <span></span>
		    <span></span>
		  </span>

		  <!-- This "nav-menu" is hidden on mobile -->
		  <!-- Add the modifier "is-active" to display it on mobile -->
		  <div id="nav-menu" class="nav-right nav-menu">
		    <a href="index.html" class="nav-item">Home</a>
		    <!--<a class="nav-item">Blog</a>-->
		    <a class="nav-item is-active">Requests</a>
		    <a href="about.html" class="nav-item">About</a>
		    <span class="nav-item"><a href="#Select+user" id="select_user" class="button is-info" onclick='return page.selectUser()'>Select user</a></span>
		  </div>
		</div>
	</nav>

	<section class="section">
		<div class="columns">
			<div class="column is-8 is-offset-2">
				<p>To request a zite be added, submit the link in the form below. Or you can send me a request by emailing me the link to the zite on ZeroMail via <a href="http://127.0.0.1:43110/Mail.ZeroNetwork.bit/?to=krixano">this link</a>. <em>Once a zite has been added, it will be removed from this requests list.</em></p>
				<br>
				<h2 class="title is-4">Requests</h2>
				<div class="columns">
					<div class="column is-6">
						<div class="field">
			  				<p class="control">
								<input type="text" id="message" class="input" onkeypress="if (event.keyCode == 13) page.sendMessage()" placeholder="Zite Link">
							</p>
						</div>
						<div class="field">
							<input type="button" id="send" class="button is-success" value="Submit!" onclick="return page.sendMessage()"/>
						</div>
					</div>
				</div>
				<ul id="messages">
				</ul>
			</div>
		</div>
	</section>

	<footer class="footer">
		<div class="container">
			<span style="text-align: center">
				<small>NOTE: This zite is still a work-in-progress.</small><br>
				<small>Zite created on April 12th, 2017 by <a href="http://127.0.0.1:43110/Me.ZeroNetwork.bit/?Profile/12h51ug6CcntU2aiBjhP8Ns2e5VypbWWtv/12gAes6NzDS9E2q6Q1UXrpUdbPS6nvuBPu/krixano@zeroid.bit">krixano@zeroid.bit</a> (Christian Seibold)</small><br>
				<small><a href="https://github.com/krixano/ImportantZites">Github Link</a></small>
			</span>
		</div>
	</footer>

	<script type="text/javascript" src="js/ZeroFrame.js"></script>
	<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="js/velocity.min.js"></script>

	<script>
		class ZeroChat extends ZeroFrame {
		    addMessage (username, message) {
		        var message_escaped = message.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&/g, "&amp;");  // Escape html tags in the message
		        this.messages.innerHTML += "<li><b>" + username + ":</b> <em><a href='" + message + "'>" + message_escaped + "</a></em></li>"
		        //var html = "<li><b>" + username + ":</b> <em><a href='" + message + "'>" + message_escaped + "</a></em></li>";
		        //$(html).hide().appendTo("#messages").fadeIn();
		    }

		    onOpenWebsocket () {
		        this.messages = document.getElementById("messages");
		        //this.addMessage("System", "Ready to call ZeroFrame API!");
		        this.cmd("siteInfo", {}, (site_info) => {
		            if (site_info.cert_user_id)
		                document.getElementById("select_user").innerText = site_info.cert_user_id;
		            this.site_info = site_info;
		        	this.loadMessages();
		        });
		    }

		    selectUser () {
	            this.cmd("certSelect", {accepted_domains: ["zeroid.bit"]})
	            return false
	        }

	        onRequest (cmd, message) {
		        if (cmd == "setSiteInfo") {
		            if (message.params.cert_user_id)
		                document.getElementById("select_user").innerHTML = message.params.cert_user_id
		            else
		                document.getElementById("select_user").innerHTML = "Select user"
		            this.site_info = message.params  // Save site info data to allow access it later

		            if (message.params.event[0] == "file_done")
		            	this.loadMessages();
		        }
		    }

		    sendMessage() {
		    	// No account selected -> Display error
		    	if (!this.site_info.cert_user_id) {
		    		this.cmd("wrapperNotification", ["info", "Please, select your account."]);
		    		this.selectUser();
		    		return false;
		    	}

		    	// This is the data file path
		    	var data_inner_path = "data/users/" + this.site_info.auth_address + "/data.json";
		    	var content_inner_path = "data/users/" + this.site_info.auth_address + "/content.json";

		    	// Load our current messages
		    	this.cmd("fileGet", {"inner_path": data_inner_path, "required": false}, (data) => {
		    		if (data)
		    			data = JSON.parse(data);
		    		else
		    			data = { "message": [] }

		    		// Add the new message to data
		    		data.message.push({
		    			"body": document.getElementById("message").value,
		    			"date_added": Date.now()
		    		});

		    		// Encode data array to utf8 json text
		    		var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')));

		    		// Write file to disk
		    		this.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
		    			if (res == "ok") {
		    				// Reset the message input
		    				document.getElementById("message").value = "";
		    				// Sign the changed file in our user's directory
		    				this.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
		    					this.loadMessages(); // Reload Messages
		    					// publish to other users
		    					this.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false});
		    				});
		    			} else {
		    				this.cmd("wrapperNotification", ["error", "File write error: #{res}"]);
		    			}
		    		});
		    	});

		    	return false;
		    }

		    loadMessages() {
	    		$("#messages").hide();
		    	this.cmd("dbQuery", ["SELECT * FROM message LEFT JOIN json USING (json_id) ORDER BY date_added DESC"], (messages) => {
		    		document.getElementById("messages").innerHTML = ""; // Always star with empty messages
		    		for (var i = 0; i < messages.length; i++) {
		    			//if (messages[i].cert_user_id == this.site_info.cert_user_id) {
	    				this.addMessage(messages[i].cert_user_id, messages[i].body);
		    			//}
		    		}
		    	});
	    		$("#messages").velocity("fadeIn", { duration: 500 });
		    }
		}

		page = new ZeroChat()
	</script>

	<!--<script>

	class Page extends ZeroFrame {
		setSiteInfo(site_info) {
			var out = document.getElementById("out")
			out.innerHTML =
				"Page address: " + site_info.address +
				"<br>- Peers: " + site_info.peers +
				"<br>- Size: " + site_info.settings.size +
				"<br>- Modified: " + (new Date(site_info.content.modified*1000))
		}

		onOpenWebsocket() {
			this.cmd("siteInfo", [], function(site_info) {
				page.setSiteInfo(site_info)
			})
		}

		onRequest(cmd, message) {
			if (cmd == "setSiteInfo")
				this.setSiteInfo(message.params)
			else
				this.log("Unknown incoming message:", cmd)
		}
	}
	page = new Page()

	</script>-->

</body>
</html>